<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Mentors Club</title>
  <meta name="description" content="Student-made math resources and mentoring from the Math Mentors Club." />
  <style>
    :root {
      --bg:#0b0c10; --card:#121318; --text:#e8e8f0; --muted:#a8adbd; --accent:#6ee7ff; --edge:#232636;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    header { position:sticky; top:0; backdrop-filter:saturate(180%) blur(10px); background:rgba(11,12,16,0.75); border-bottom:1px solid var(--edge); z-index:10; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { font-weight: 800; letter-spacing:0.3px; }
    .pill { display:inline-block; padding: 6px 12px; border:1px solid var(--edge); border-radius:999px; color:var(--text); position:relative; }
    .hero { padding: 48px 0 20px; text-align:left; }
    .hero h1 { font-size: clamp(28px, 6vw, 40px); margin: 0 0 10px; }
    .hero p { color: var(--muted); margin:0; font-size: 16px; }
    .cta { margin-top: 18px; display:flex; gap:12px; flex-wrap:wrap; }
    .btn { display:inline-block; padding:10px 14px; background:linear-gradient(180deg,#1a1f2b,#10131a); border:1px solid var(--edge); border-radius:12px; color:var(--text); font-weight:600; }
    .btn:hover { border-color:#2d3347; }
    .section { padding: 28px 0; }
    h2 { font-size: 22px; margin: 0 0 12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:14px; }
    .card { background: var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:8px; }
    .card h3 { margin:0; font-size:18px; }
    .badge { font-size:12px; color: var(--muted); }
    .small { color: var(--muted); font-size: 14px; }
    footer { border-top:1px solid var(--edge); padding:20px 0 40px; color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; color:#9fb2d0; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; position:relative; }
    .input, .select { padding:10px; border:1px solid var(--edge); background:#0f1117; color:var(--text); border-radius:10px; }
    .dropdown { display:none; margin-top:8px; border:1px solid var(--edge); background:#0f1117; border-radius:12px; }
    .dropdown.open { display:block; }
    .dropdown-inner { padding:8px; }
    .dropdown-list { list-style:none; margin:0; padding:0; display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:6px; }
    .dropdown-item { padding:8px 10px; border:1px solid transparent; border-radius:10px; background:transparent; color:var(--text); cursor:pointer; text-align:left; }
    .dropdown-item:hover, .dropdown-item:focus { border-color:#2d3347; outline:none; }
    .input { flex:1; min-width:220px; }
    .acct { position:relative; }
    .menu { display:none; position:absolute; right:0; top:calc(100% + 8px); background:#0f1117; border:1px solid var(--edge); border-radius:12px; min-width:180px; z-index:20; }
    .menu.open { display:block; }
    .menu a, .menu button { display:block; padding:10px 12px; color:var(--text); text-align:left; background:none; border:none; width:100%; cursor:pointer; }
    .menu a:hover, .menu button:hover { background:#1a1f2b; }
    /* Admin table */
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid var(--edge); padding:8px 10px; text-align:left; }
    th { background:#0f1117; color:var(--muted); }
    .hidden { display:none !important; }
  </style>
  <script>
    window.MathJax = { tex: { inlineMath: [['$','$'],['\\(','\\)']] }, svg: { fontCache: 'global' } };
  </script>
  <script async id="mathjax" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand"><a href="index.html" style="color:inherit;text-decoration:none">Math Mentors Club</a></div>
      <nav style="display:flex;gap:10px;align-items:center">
        <a class="pill" href="#resources">Resources</a>
        <a class="pill" href="about.html">About</a>
        <a class="pill" href="join.html">Join</a>
        <div class="acct">
          <a class="pill" id="accountLink" href="login.html">Account</a>
          <div id="accountMenu" class="menu" aria-label="Account menu">
            <a href="profile.html">Profile</a>
            <button id="logoutBtn" type="button">Log out</button>
          </div>
        </div>
        <a class="pill hidden" id="admin-link" href="#admin">Admin</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>Student-made math resources & mentoring</h1>
      <p>We create clear, friendly materials for younger learners and mentor students locally and online.</p>
      <div class="cta">
        <a class="btn" href="#resources">Browse resources</a>
        <a class="btn" href="join.html">Get involved</a>
      </div>
    </section>

    <section id="resources" class="section">
      <h2>Resources</h2>
      <p class="small">PDF problem sets and study guides made by our members. Everything here is free to use.</p>
      <div class="controls" role="search">
        <input id="search" class="input" type="search" placeholder="Search resources… (title)" aria-label="Search resources" />
        <select id="filter" class="select" aria-label="Search filter">
          <option value="title" selected>Title</option>
          <option value="level">Difficulty</option>
          <option value="tag">Topic (hashtag)</option>
        </select>
      </div>
      <div id="suggestions" class="dropdown" aria-label="Suggestions" role="listbox" aria-expanded="false"></div>
      <div id="resource-grid" class="grid" aria-live="polite"></div>
    </section>

    <!-- Admin Panel -->
    <section id="admin" class="section hidden">
      <h2>Admin</h2>
      <div class="card">
        <p class="small">Registered users (from Supabase <code class="mono">profiles</code>):</p>
        <div style="overflow:auto">
          <table id="admin-table">
            <thead>
              <tr>
                <th>First</th><th>Last</th><th>Username</th><th>Email</th><th>Created</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p id="admin-msg" class="small"></p>
      </div>
    </section>

    <section class="section">
      <h2>How to add new resources</h2>
      <div class="card">
        <ol class="small">
          <li>Place your PDF in the <span class="mono">/resources</span> folder of this site (e.g., <span class="mono">/resources/probability-pack.pdf</span>).</li>
          <li>Add an entry to the <span class="mono">resources</span> array in the script below (title, level, summary, file path).</li>
          <li>Commit & push — the grid above updates automatically.</li>
        </ol>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <div class="small">© <span id="year"></span> Math Mentors Club · Made by students · LaTeX-friendly · CC BY 4.0</div>
    </div>
  </footer>

  <!-- Supabase setup -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://xftcwjrnbphzbetbcnsw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhmdGN3anJuYnBoemJldGJjbnN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzA4MTEsImV4cCI6MjA3MTQwNjgxMX0.PM4JJLgZ2aBs3QKSPS5rZshU01ZRavbbmVRjmSYSOPE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const adminEmails = ["legorjuho@gmail.com"];

    // Flash banner from login/profile redirects (?msg=...)
    const params = new URLSearchParams(window.location.search);
    const flash = params.get('msg');
    if (flash) {
      const wrap = document.querySelector('main .wrap') || document.querySelector('.wrap');
      const note = document.createElement('div');
      note.className = 'card';
      note.style.marginTop = '12px';
      note.innerHTML = `<p class="small">${decodeURIComponent(flash)}</p>`;
      wrap?.prepend(note);
      const url = new URL(window.location.href);
      url.search = '';
      history.replaceState({}, '', url);
    }
  </script>

  <script>
    // ---------- Resources (search + suggestions) ----------
    const resources = [
      { title: "Fractions Basics Pack", level: "Middle School", file: "/resources/fractions-pack.pdf", summary: "10 scaffolded problems with step-by-step solutions.", tags: ["arithmetic", "fractions"] },
      { title: "Intro to Probability (with dice & coins)", level: "Middle–High", file: "/resources/intro-probability.pdf", summary: "Short guide + 8 practice problems and full solutions.", tags: ["probability"] },
      { title: "Factoring Quadratics Quick Guide", level: "High School", file: "/resources/factoring-quadratics.pdf", summary: "Examples, checks, and a one-page reference.", tags: ["algebra"] }
    ];

    const grid = document.getElementById('resource-grid');
    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('filter');
    const dropdown = document.getElementById('suggestions');

    const uniqueLevels = Array.from(new Set((resources.map(r => r.level || '').filter(Boolean)))).sort();
    const uniqueTags = Array.from(new Set(resources.flatMap(r => r.tags || []).filter(Boolean))).sort();

    function card(r){
      const div = document.createElement('article');
      div.className = 'card';
      div.innerHTML = `
        <h3>${r.title}</h3>
        <div class="badge">${r.level || ''}</div>
        <p class="small">${r.summary || ''}</p>
        <div class="small">${(r.tags||[]).map(t=>`#${t}`).join(' ')}</div>
        <div>
          <a class="btn" href="${r.file}" target="_blank" rel="noopener">Open PDF</a>
        </div>`;
      return div;
    }

    function matches(r, q, type){
      if(!q) return true;
      q = q.toLowerCase();
      if(type === 'title') return (r.title||'').toLowerCase().includes(q);
      if(type === 'level') return (r.level||'').toLowerCase().includes(q);
      if(type === 'tag') return (r.tags||[]).some(t => (t||'').toLowerCase().includes(q));
      return true;
    }

    function render(){
      grid.innerHTML = '';
      const q = (searchInput?.value || '').trim();
      const type = filterSelect?.value || 'title';
      const list = resources.filter(r => matches(r, q, type));
      if(list.length === 0){
        const empty = document.createElement('p');
        empty.className = 'small';
        empty.textContent = 'No resources match your search yet. Try a different keyword or filter.';
        grid.appendChild(empty);
      } else {
        list.forEach(r => grid.appendChild(card(r)));
      }
    }

    function suggestionTemplate(items){
      const wrap = document.createElement('div');
      wrap.className = 'dropdown-inner';
      const ul = document.createElement('ul');
      ul.className = 'dropdown-list';
      items.forEach(v => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item';
        btn.setAttribute('role','option');
        btn.textContent = v;
        btn.addEventListener('click', e => {
          e.stopPropagation();
          searchInput.value = v;
          closeDropdown();
          render();
          searchInput.focus();
        });
        li.appendChild(btn);
        ul.appendChild(li);
      });
      wrap.appendChild(ul);
      return wrap;
    }

    function openDropdown(type, query=''){
      if(type === 'title'){ closeDropdown(); return; }
      const base = type === 'level' ? uniqueLevels : uniqueTags;
      const q = (query || '').toLowerCase();
      const items = base.filter(v => v.toLowerCase().includes(q));
      dropdown.innerHTML = '';
      dropdown.appendChild(suggestionTemplate(items));
      dropdown.classList.add('open');
      dropdown.setAttribute('aria-expanded','true');
    }
    function closeDropdown(){
      dropdown.classList.remove('open');
      dropdown.setAttribute('aria-expanded','false');
      dropdown.innerHTML = '';
    }

    filterSelect?.addEventListener('change', ()=>{
      const map = { title:'Search resources… (title)', level:'Search… (difficulty)', tag:'Search… (topic)' };
      if(searchInput) searchInput.placeholder = map[filterSelect.value] || 'Search resources…';
      if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value);
      else closeDropdown();
      render();
    });
    searchInput?.addEventListener('focus', ()=>{ if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value); });
    searchInput?.addEventListener('click', ()=>{ if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value); });
    searchInput?.addEventListener('input', ()=>{ if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value); render(); });

    document.addEventListener('click', (e)=>{
      const withinControls = e.target.closest('.controls');
      const withinDropdown = e.target.closest('#suggestions');
      if(!withinControls && !withinDropdown) closeDropdown();
    });

    render();

    // ---------- Auth: navbar Account dropdown + Admin table ----------
    const accountLink = document.getElementById('accountLink');
    const accountMenu = document.getElementById('accountMenu');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminLink = document.getElementById('admin-link');
    const adminSection = document.getElementById('admin');
    const adminMsg = document.getElementById('admin-msg');
    const adminTableBody = document.querySelector('#admin-table tbody');

    function setAdminMsg(t, ok=true){ adminMsg.textContent = t || ''; adminMsg.style.color = ok ? 'var(--muted)' : '#ff9b9b'; }
    function isAdminEmail(email){ return (["legorjuho@gmail.com"]).includes((email||'').toLowerCase()); }

    async function refreshAdminList(){
      adminTableBody.innerHTML = '';
      const { data, error } = await supabase.from('profiles').select('first_name,last_name,username,email,created_at').order('created_at', { ascending:false });
      if(error){ setAdminMsg('Could not load users. Check policy for admin read.', false); return; }
      (data||[]).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.first_name??''}</td><td>${row.last_name??''}</td><td>${row.username??''}</td><td>${row.email??''}</td><td>${(row.created_at??'').toString().slice(0,19).replace('T',' ')}</td>`;
        adminTableBody.appendChild(tr);
      });
      setAdminMsg(`Loaded ${data?.length||0} users.`);
    }

    function openAcctMenu(){ accountMenu.classList.add('open'); }
    function closeAcctMenu(){ accountMenu.classList.remove('open'); }

    document.addEventListener('click', (e)=>{
      if(!e.target.closest('.acct')) closeAcctMenu();
    });

    logoutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      closeAcctMenu();
      window.location.href = 'index.html?msg=' + encodeURIComponent('Logged out.');
    });

    async function setupNavbar(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(user){
        // Turn Account link into a button that toggles the dropdown
        accountLink.href = 'javascript:void(0)';
        accountLink.addEventListener('click', (e)=>{ e.preventDefault(); accountMenu.classList.toggle('open'); });
        accountLink.textContent = user.email || 'Account';
        if(isAdminEmail(user.email)){
          adminLink.classList.remove('hidden');
          adminSection.classList.remove('hidden');
          refreshAdminList();
        } else {
          adminLink.classList.add('hidden');
          adminSection.classList.add('hidden');
        }
      }else{
        // Logged out: keep it as a link to login page
        accountLink.href = 'login.html';
        accountLink.textContent = 'Account';
        adminLink.classList.add('hidden');
        adminSection.classList.add('hidden');
      }
    }

    supabase.auth.onAuthStateChange((_evt,_sess)=> setupNavbar());
    setupNavbar();

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
