<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Mentors Club</title>
  <meta name="description" content="Student-made math resources and mentoring from the Math Mentors Club." />
  <style>
    :root {
      --bg:#0b0c10; --card:#121318; --text:#e8e8f0; --muted:#a8adbd; --accent:#6ee7ff; --edge:#232636;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    header { position:sticky; top:0; backdrop-filter:saturate(180%) blur(10px); background:rgba(11,12,16,0.75); border-bottom:1px solid var(--edge); z-index:10; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { font-weight: 800; letter-spacing:0.3px; }
    .pill { display:inline-block; padding: 6px 12px; border:1px solid var(--edge); border-radius:999px; color:var(--text); }
    .hero { padding: 48px 0 20px; text-align:left; }
    .hero h1 { font-size: clamp(28px, 6vw, 40px); margin: 0 0 10px; }
    .hero p { color: var(--muted); margin:0; font-size: 16px; }
    .cta { margin-top: 18px; display:flex; gap:12px; flex-wrap:wrap; }
    .btn { display:inline-block; padding:10px 14px; background:linear-gradient(180deg,#1a1f2b,#10131a); border:1px solid var(--edge); border-radius:12px; color:var(--text); font-weight:600; }
    .btn:hover { border-color:#2d3347; }
    .section { padding: 28px 0; }
    h2 { font-size: 22px; margin: 0 0 12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:14px; }
    .card { background: var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:8px; }
    .card h3 { margin:0; font-size:18px; }
    .badge { font-size:12px; color: var(--muted); }
    .small { color: var(--muted); font-size: 14px; }
    footer { border-top:1px solid var(--edge); padding:20px 0 40px; color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; color:#9fb2d0; }
    .code { background:#0f1117; padding:10px; border-radius:10px; border:1px solid var(--edge); overflow:auto; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; position:relative; }
    .input, .select { padding:10px; border:1px solid var(--edge); background:#0f1117; color:var(--text); border-radius:10px; }
    .dropdown { display:none; margin-top:8px; border:1px solid var(--edge); background:#0f1117; border-radius:12px; }
    .dropdown.open { display:block; }
    .dropdown-inner { padding:8px; }
    .dropdown-list { list-style:none; margin:0; padding:0; display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:6px; }
    .dropdown-item { padding:8px 10px; border:1px solid transparent; border-radius:10px; background:transparent; color:var(--text); cursor:pointer; text-align:left; }
    .dropdown-item:hover, .dropdown-item:focus { border-color:#2d3347; outline:none; }
    .input { flex:1; min-width:220px; }
    .suggestions { position:absolute; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--edge); border-radius:10px; margin-top:4px; z-index:20; max-height:200px; overflow:auto; display:none; }
    .suggestions div { padding:8px 10px; cursor:pointer; }
    .suggestions div:hover { background:#1a1f2b; }
    /* Simple table for admin list */
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid var(--edge); padding:8px 10px; text-align:left; }
    th { background:#0f1117; color:var(--muted); }
    .hidden { display:none !important; }
  </style>
  <script>
    window.MathJax = { tex: { inlineMath: [['$','$'],['\\(','\\)']] }, svg: { fontCache: 'global' } };
  </script>
  <script async id="mathjax" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand">Math Mentors Club</div>
      <nav>
        <a class="pill" href="#resources">Resources</a>
        <a class="pill" href="#about">About</a>
        <a class="pill" href="#join">Join</a>
      <a class="pill" href="#account">Account</a>
        <a class="pill hidden" id="admin-link" href="#admin">Admin</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>Student-made math resources & mentoring</h1>
      <p>We create clear, friendly materials for younger learners and mentor students locally and online.</p>
      <div class="cta">
        <a class="btn" href="#resources">Browse resources</a>
        <a class="btn" href="#join">Get involved</a>
      </div>
    </section>

    <section id="resources" class="section">
      <h2>Resources</h2>
      <p class="small">PDF problem sets and study guides made by our members. Everything here is free to use.</p>
      <div class="controls" role="search">
        <input id="search" class="input" type="search" placeholder="Search resources… (title)" aria-label="Search resources" />
        <select id="filter" class="select" aria-label="Search filter">
          <option value="title" selected>Title</option>
          <option value="level">Difficulty</option>
          <option value="tag">Topic (hashtag)</option>
        </select>
      </div>
      <!-- Suggestion dropdown: appears below the controls and pushes content down (no overlap) -->
      <div id="suggestions" class="dropdown" aria-label="Suggestions" role="listbox" aria-expanded="false"></div>
      <div id="resource-grid" class="grid" aria-live="polite"></div>
    </section>

    <section id="about" class="section">
      <h2>About</h2>
      <p class="small">
        The Math Mentors Club builds bite-sized math resources (problem sets with worked solutions, mini study guides, and challenge packets)
        using LaTeX, then shares them with younger students at our school and online. Some members also volunteer as tutors.
      </p>
    </section>

    <section id="join" class="section">
      <h2>Join</h2>
      <div class="card">
        <p class="small"><strong>Members do one or more of the following:</strong> write problems, edit solutions, format LaTeX, or mentor students. Tutoring is optional.</p>
        <p class="small">Email us at <a href="mailto:mathmentors@example.com">mathmentors@example.com</a> or talk to the officers at the next meeting.</p>
      </div></section>

    <!-- Account / Auth -->
    <section id="account" class="section">
      <h2>Account</h2>
      <div class="card" id="auth-card">
        <p class="small" id="auth-status">You are not logged in.</p>
        <div id="auth-form">
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <input class="input" id="acc-first" type="text" placeholder="First name" autocomplete="given-name">
            <input class="input" id="acc-last" type="text" placeholder="Last name" autocomplete="family-name">
            <input class="input" id="acc-username" type="text" placeholder="Username" autocomplete="nickname">
            <input class="input" id="acc-email" type="email" placeholder="Email" autocomplete="email">
            <input class="input" id="acc-pass" type="password" placeholder="Password" autocomplete="new-password">
          </div>
          <div class="cta" style="margin-top:12px;">
            <button class="btn" id="btn-signup" type="button">Sign Up</button>
            <button class="btn" id="btn-login" type="button">Log In</button>
            <button class="btn" id="btn-logout" type="button">Log Out</button>
          </div>
          <p class="small" id="auth-msg"></p>
        </div>
      </div>
    </section>

    <!-- Admin Panel -->
    <section id="admin" class="section hidden">
      <h2>Admin</h2>
      <div class="card">
        <p class="small">Registered users (from Supabase <code class="mono">profiles</code>):</p>
        <div style="overflow:auto">
          <table id="admin-table">
            <thead>
              <tr>
                <th>First</th><th>Last</th><th>Username</th><th>Email</th><th>Created</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>How to add new resources</h2>
      <div class="card">
        <ol class="small">
          <li>Place your PDF in the <span class="mono">/resources</span> folder of this site (e.g., <span class="mono">/resources/probability-pack.pdf</span>).</li>
          <li>Add an entry to the <span class="mono">resources</span> array in the script below (title, level, summary, file path).</li>
          <li>Commit & push — the grid above updates automatically.</li>
        </ol>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <div class="small">© <span id="year"></span> Math Mentors Club · Made by students · LaTeX-friendly · CC BY 4.0</div>
    </div>
  </footer>

  <script>
    const resources = [
      { title: "Fractions Basics Pack", level: "Middle School", file: "/resources/fractions-pack.pdf", summary: "10 scaffolded problems with step-by-step solutions.", tags: ["arithmetic", "fractions"] },
      { title: "Intro to Probability (with dice & coins)", level: "Middle–High", file: "/resources/intro-probability.pdf", summary: "Short guide + 8 practice problems and full solutions.", tags: ["probability"] },
      { title: "Factoring Quadratics Quick Guide", level: "High School", file: "/resources/factoring-quadratics.pdf", summary: "Examples, checks, and a one-page reference.", tags: ["algebra"] }
    ];

    const grid = document.getElementById('resource-grid');
    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('filter');
    const dropdown = document.getElementById('suggestions');

    // Build unique lists for suggestions
    const uniqueLevels = Array.from(new Set((resources.map(r => r.level || '').filter(Boolean)))).sort();
    const uniqueTags = Array.from(new Set(resources.flatMap(r => r.tags || []).filter(Boolean))).sort();

    function card(r){
      const div = document.createElement('article');
      div.className = 'card';
      div.innerHTML = `
        <h3>${r.title}</h3>
        <div class="badge">${r.level || ''}</div>
        <p class="small">${r.summary || ''}</p>
        <div class="small">${(r.tags||[]).map(t=>`#${t}`).join(' ')}</div>
        <div>
          <a class="btn" href="${r.file}" target="_blank" rel="noopener">Open PDF</a>
        </div>`;
      return div;
    }

    function matches(r, q, type){
      if(!q) return true;
      q = q.toLowerCase();
      if(type === 'title') return (r.title||'').toLowerCase().includes(q);
      if(type === 'level') return (r.level||'').toLowerCase().includes(q);
      if(type === 'tag') return (r.tags||[]).some(t => (t||'').toLowerCase().includes(q));
      return true;
    }

    function render(){
      grid.innerHTML = '';
      const q = (searchInput?.value || '').trim();
      const type = filterSelect?.value || 'title';
      const list = resources.filter(r => matches(r, q, type));
      if(list.length === 0){
        const empty = document.createElement('p');
        empty.className = 'small';
        empty.textContent = 'No resources match your search yet. Try a different keyword or filter.';
        grid.appendChild(empty);
      }
      list.forEach(r => grid.appendChild(card(r)));
    }

    // ===== Dropdown (suggestions) =====
    function suggestionTemplate(items){
      const wrap = document.createElement('div');
      wrap.className = 'dropdown-inner';
      const ul = document.createElement('ul');
      ul.className = 'dropdown-list';
      items.forEach(v => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item';
        btn.setAttribute('role','option');
        btn.textContent = v;
        btn.addEventListener('click', e => {
          e.stopPropagation();
          searchInput.value = v;
          closeDropdown();
          render();
          searchInput.focus();
        });
        li.appendChild(btn);
        ul.appendChild(li);
      });
      wrap.appendChild(ul);
      return wrap;
    }

    function openDropdown(type, query=''){
      if(type === 'title'){ closeDropdown(); return; }
      const base = type === 'level' ? uniqueLevels : uniqueTags;
      const q = (query || '').toLowerCase();
      const items = base.filter(v => v.toLowerCase().includes(q));
      dropdown.innerHTML = '';
      dropdown.appendChild(suggestionTemplate(items));
      dropdown.classList.add('open');
      dropdown.setAttribute('aria-expanded','true');
    }

    function closeDropdown(){
      dropdown.classList.remove('open');
      dropdown.setAttribute('aria-expanded','false');
      dropdown.innerHTML = '';
    }

    filterSelect?.addEventListener('change', ()=>{
      const map = { title:'Search resources… (title)', level:'Search… (difficulty)', tag:'Search… (topic)' };
      if(searchInput) searchInput.placeholder = map[filterSelect.value] || 'Search resources…';
      // Refresh dropdown for non-title filters
      if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value);
      else closeDropdown();
      render();
    });

    searchInput?.addEventListener('focus', ()=>{
      if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value);
    });
    searchInput?.addEventListener('click', ()=>{
      if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value);
    });
    searchInput?.addEventListener('input', ()=>{
      if(filterSelect.value !== 'title') openDropdown(filterSelect.value, searchInput.value);
      render();
    });

    // Click-outside to close
    document.addEventListener('click', (e)=>{
      const withinControls = e.target.closest('.controls');
      const withinDropdown = e.target.closest('#suggestions');
      if(!withinControls && !withinDropdown) closeDropdown();
    });

    // Initial render
    render();

    // ===== Auth / Admin (Supabase) =====
    const authStatus = document.getElementById('auth-status');
    const authMsg = document.getElementById('auth-msg');
    const btnSignup = document.getElementById('btn-signup');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const accFirst = document.getElementById('acc-first');
    const accLast = document.getElementById('acc-last');
    const accUser = document.getElementById('acc-username');
    const accEmail = document.getElementById('acc-email');
    const accPass = document.getElementById('acc-pass');

    const adminSection = document.getElementById('admin');
    const adminLink = document.getElementById('admin-link');
    const adminTableBody = document.querySelector('#admin-table tbody');

    function setMsg(text, ok=true){
      authMsg.textContent = text || '';
      authMsg.style.color = ok ? 'var(--muted)' : '#ff9b9b';
    }

    function isAdminEmail(email){
      return (adminEmails || []).map(e=>e.toLowerCase()).includes((email||'').toLowerCase());
    }

    async function upsertOwnProfile(values={}){
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if(!user) return;
        const payload = {
          id: user.id,
          email: user.email,
          username: values.username || accUser.value || null,
          first_name: values.first_name || accFirst.value || null,
          last_name: values.last_name || accLast.value || null
        };
        await supabase.from('profiles').upsert(payload);
      }catch(err){ setMsg('Profile save failed.', false); }
    }

    async function refreshAdminList(){
      adminTableBody.innerHTML = '';
      const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending:false });
      if(error){ setMsg('Admin load failed. Check policies.', false); return; }
      (data||[]).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.first_name||''}</td><td>${row.last_name||''}</td><td>${row.username||''}</td><td>${row.email||''}</td><td>${(row.created_at||'').toString().slice(0,19).replace('T',' ')}</td>`;
        adminTableBody.appendChild(tr);
      });
    }

    async function updateAuthUI(){
      const { data: { user } } = await supabase.auth.getUser();
      if(user){
        authStatus.textContent = `Logged in as ${user.email}`;
        // show logout button, hide nothing (we keep form for updates)
        btnLogout.style.display = 'inline-block';
        if(isAdminEmail(user.email)){
          adminSection.classList.remove('hidden');
          adminLink.classList.remove('hidden');
          refreshAdminList();
        } else {
          adminSection.classList.add('hidden');
          adminLink.classList.add('hidden');
        }
      } else {
        authStatus.textContent = 'You are not logged in.';
        btnLogout.style.display = 'inline-block';
        adminSection.classList.add('hidden');
        adminLink.classList.add('hidden');
      }
    }

    btnSignup?.addEventListener('click', async ()=>{
      setMsg('');
      const email = accEmail.value.trim();
      const password = accPass.value;
      const first = accFirst.value.trim();
      const last = accLast.value.trim();
      const username = accUser.value.trim();
      if(!email || !password || !first || !last || !username){ setMsg('Please fill all fields.', false); return; }
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error){ setMsg(error.message, false); return; }
      await upsertOwnProfile({ first_name:first, last_name:last, username });
      setMsg('Sign up successful. Check your email if verification is required.');
      updateAuthUI();
    });

    btnLogin?.addEventListener('click', async ()=>{
      setMsg('');
      const email = accEmail.value.trim();
      const password = accPass.value;
      if(!email || !password){ setMsg('Enter email and password.', false); return; }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ setMsg(error.message, false); return; }
      await upsertOwnProfile(); // optional: sync names/username if provided
      setMsg('Logged in.');
      updateAuthUI();
    });

    btnLogout?.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      setMsg('Logged out.');
      updateAuthUI();
    });

    supabase.auth.onAuthStateChange((_event, _session)=>{ updateAuthUI(); });
    updateAuthUI();

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
